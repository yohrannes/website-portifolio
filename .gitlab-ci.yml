---
include:
  - local: 'pipelines/gitlab-ci-cd/1-pipelocal-infra-runner-oci-arm.yml'
    rules:
      - if: $CI_COMMIT_BRANCH == "infra-runner-oci-arm"


  - local: 'pipelines/gitlab-ci-cd/2-infra-runner-gcp-amd.yml'
    rules:
      - if: $CI_COMMIT_BRANCH == "infra-runner-gcp-amd"


  - local: 'pipelines/gitlab-ci-cd/3-infra-webapp-oci-amd.yml'
    rules:
      - if: $CI_COMMIT_BRANCH == "infra-webapp-oci-amd"


  - local: 'pipelines/gitlab-ci-cd/4-infra-oci-oke-arm.yml'
    rules:
      - if: $CI_COMMIT_BRANCH == "infr-cluster-oci-arm"


  - local: 'pipelines/gitlab-ci-cd/runner-controler.yml'
    rules:
      - if: $CI_COMMIT_BRANCH =! "infra-runner-oci-arm"

  - local: 'pipelines/gitlab-ci-cd/develop.yml'
    rules:
      - if: $CI_COMMIT_BRANCH == "develop"


variables:
  IMAGE_NAME: yohrannes/website-portifolio
  IMAGE_TAG: latest


stages:
  - prepare

  - create-infra
  - test-infra
  - deploy-infra

  - build
  - test
  - deploy-image
  - deploy


deploy-dk-hub:
  stage: deploy-image
  rules:
      - if: $CI_COMMIT_BRANCH == "main"
  tags: [ "oci-runner-arm" ]
  before_script:
    - echo "$DOCKER_REG_PASSWORD" | docker login -u yohrannes --password-stdin
  script:
    - mkdir -p repos-gitlab
    - cd repos-gitlab
    - git clone https://gitlab.com/yohrannes/website-portifolio.git
    - cd website-portifolio
    - git checkout develop

    - OLD_TAG=v$(./usefull-scripts/old-dk-img-version.sh)
    - NEW_TAG=v$(./usefull-scripts/nx-dk-img-version.sh)

    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    - docker buildx create --use --name multiarchbuilder

    - docker buildx build -f build-app/Dockerfile --platform linux/arm64 -t $IMAGE_NAME:$NEW_TAG-arm64 --push .
    - docker buildx build -f build-app/Dockerfile --platform linux/arm64 -t $IMAGE_NAME:$NEW_TAG-amd64 --push .

    - DIGEST_AMD64=$(curl -s "https://registry.hub.docker.com/v2/repositories/yohrannes/website-portifolio/tags?page_size=100" | jq -r --arg tag "$NEW_TAG-amd64" '.results[] | select(.name == $tag) | .digest')
    - DIGEST_ARM64=$(curl -s "https://registry.hub.docker.com/v2/repositories/yohrannes/website-portifolio/tags?page_size=100" | jq -r --arg tag "$NEW_TAG-arm64" '.results[] | select(.name == $tag) | .digest')

    - |
      docker manifest create $IMAGE_NAME:$NEW_TAG \
          --amend $IMAGE_NAME@$DIGEST_AMD64 \
          --amend $IMAGE_NAME@$DIGEST_ARM64

    - docker manifest push $IMAGE_NAME:$NEW_TAG
    - docker manifest push $IMAGE_NAME:latest

    - echo "image-changed"
    - echo "Old version $OLD_TAG changed to the new version $NEW_TAG"

# Assign image with cosign job
#  cosign sign -key ../../cosign-keys/cosign.key yohrannes/website-portifolio

deploy-dkcmpose:
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  before_script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
  script:
    - |
      ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$TF_INSTANCE_PUBLIC_IP "
        mkdir -p repos-git
        cd repos-git
        git clone https://gitlab.com/yohrannes/website-portifolio.git
        cd website-portifolio
        git checkout main
        sudo docker build -qf ./build-app/Dockerfile --network host -t yohrannes/website-portifolio:latest .
        cd docker-compose
        sudo docker compose up -d
      "